{% extends 'base.html' %}

{% block title %}Emergency Fake Call - SafeSpace{% endblock %}

{% block extra_css %}
<style>
    :root{
        --accent: #25d366;
        --danger: #dc3545;
    }
    
    .fake-call-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 1rem;
    }
    
    .fake-call-card{
        background: rgba(255,255,255,0.98);
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.1);
    }
    
    .fake-call-card h1 {
        font-size: 28px;
        margin-bottom: 12px;
        color: #2D3748;
        font-weight: 700;
    }
    
    .fake-call-card .lead {
        color: #4A5568;
        margin-bottom: 24px;
        font-size: 16px;
    }

    .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .controls input[type="text"],
    .controls input[type="number"] {
        flex: 1;
        min-width: 180px;
        padding: 12px 16px;
        border-radius: 8px;
        border: 2px solid #E2E8F0;
        outline: none;
        font-size: 15px;
        transition: border-color 0.2s;
    }
    
    .controls input:focus {
        border-color: #8B5CF6;
    }
    
    .controls input[type="number"] {
        flex: 0 0 120px;
    }
    
    .buttons {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    button.btn-fake-call {
        flex: 1;
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        color: #fff;
        padding: 16px 28px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        font-size: 17px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }
    
    button.btn-fake-call:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 24px rgba(37, 211, 102, 0.4);
    }
    
    button.btn-fake-call:active {
        transform: translateY(-1px);
    }
    
    button.btn-schedule {
        flex: 1;
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        color: #fff;
        padding: 16px 28px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        font-size: 17px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    button.btn-schedule:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 24px rgba(139, 92, 246, 0.4);
    }
    
    button.btn-schedule:active {
        transform: translateY(-1px);
    }

    .hint {
        font-size: 14px;
        color: #4A5568;
        margin-top: 16px;
        padding: 16px;
        background: linear-gradient(135deg, #F7FAFC 0%, #EDF2F7 100%);
        border-radius: 12px;
        border-left: 4px solid #8B5CF6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        line-height: 1.6;
    }
    
    .hint strong {
        color: #2D3748;
        display: block;
        margin-bottom: 4px;
    }

    /* Call screen overlay */
    .call-screen {
        display: none;
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .call-panel {
        background: #fff;
        width: 90%;
        max-width: 380px;
        border-radius: 32px;
        padding: 48px 24px;
        text-align: center;
        box-shadow: 0 25px 80px rgba(0,0,0,0.5);
        animation: slideUp 0.5s ease;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .avatar {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 64px;
        margin-bottom: 24px;
        box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
    }
    
    .caller-name {
        font-weight: 700;
        font-size: 28px;
        color: #2D3748;
        margin-bottom: 8px;
    }
    
    .call-status {
        color: #64748B;
        margin-top: 8px;
        font-size: 16px;
        font-weight: 500;
    }
    
    .call-actions {
        display: flex;
        gap: 32px;
        justify-content: center;
        margin-top: 32px;
    }
    
    .action-btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: none;
        color: #fff;
        font-size: 32px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .action-btn:hover {
        transform: scale(1.15);
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.3);
    }
    
    .action-btn:active {
        transform: scale(1.05);
    }
    
    .action-accept {
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        box-shadow: 0 8px 24px rgba(37, 211, 102, 0.5);
    }
    
    .action-accept:hover {
        box-shadow: 0 12px 32px rgba(37, 211, 102, 0.6);
    }
    
    .action-decline {
        background: linear-gradient(135deg, #DC3545 0%, #BD2130 100%);
        box-shadow: 0 8px 24px rgba(220, 53, 69, 0.5);
    }
    
    .action-decline:hover {
        box-shadow: 0 12px 32px rgba(220, 53, 69, 0.6);
    }

    .countdown-text {
        font-size: 15px;
        color: #64748B;
        margin-top: 20px;
        font-weight: 600;
        background: #F1F5F9;
        padding: 12px 20px;
        border-radius: 12px;
        display: inline-block;
    }

    @media (max-width: 640px) {
        .fake-call-card {
            padding: 24px;
        }
        
        .controls {
            flex-direction: column;
        }
        
        .controls input[type="number"] {
            flex: 1;
        }
        
        .buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fake-call-container">
    <div class="fake-call-card">
        <h1>üö® Emergency Fake Call</h1>
        <p class="lead">Create a believable incoming call to help you leave an uncomfortable or unsafe situation discreetly.</p>

        <div class="controls">
            <input id="callerName" type="text" placeholder="Caller name (e.g., Mom, Friend)" value="Mom">
            <input id="delay" type="number" min="0" placeholder="Delay (sec)" value="0">
        </div>

        <div class="buttons">
            <button id="nowBtn" class="btn-fake-call">üìû Receive Now</button>
            <button id="scheduleBtn" class="btn-schedule">‚è∞ Schedule Call</button>
        </div>

        <div class="hint">
            <strong>üí° How it works:</strong> Simulates a realistic incoming call with ringtone and voice conversation. Perfect for escaping uncomfortable situations. You can decline at any time or let it end naturally.
        </div>
    </div>
</div>

<div class="call-screen" id="callScreen" aria-hidden="true">
    <div class="call-panel" role="dialog" aria-label="Incoming call">
        <div class="avatar" id="avatar">üë§</div>
        <div class="caller-name" id="displayName">Mom</div>
        <div class="call-status" id="callStatus">WhatsApp voice call...</div>

        <div class="call-actions">
            <button class="action-btn action-decline" id="declineBtn" title="Decline" aria-label="Decline call">
                ‚úï
            </button>
            <button class="action-btn action-accept" id="answerBtn" title="Answer" aria-label="Answer call">
                ‚úì
            </button>
        </div>

        <div class="countdown-text" id="countdownArea"></div>
    </div>
</div>

<!-- Audio files -->
<audio id="ringtone" loop preload="auto">
    <source src="{{ url_for('static', filename='audio/whatsapp-ringtone.mp3') }}" type="audio/mp3">
</audio>
<audio id="conversation" preload="auto">
    <source src="{{ url_for('static', filename='audio/conversation.mp3') }}" type="audio/mp3">
</audio>

<script>
    // Elements
    const nowBtn = document.getElementById('nowBtn');
    const scheduleBtn = document.getElementById('scheduleBtn');
    const callerNameInput = document.getElementById('callerName');
    const delayInput = document.getElementById('delay');

    const callScreen = document.getElementById('callScreen');
    const displayName = document.getElementById('displayName');
    const callStatus = document.getElementById('callStatus');
    const countdownArea = document.getElementById('countdownArea');

    const answerBtn = document.getElementById('answerBtn');
    const declineBtn = document.getElementById('declineBtn');

    const ringtone = document.getElementById('ringtone');
    const conversation = document.getElementById('conversation');

    let scheduleTimer = null;
    let countdownTimer = null;

    // Safety: wrap play() calls to catch autoplay rejections
    async function safePlay(audioEl) {
        try {
            await audioEl.play();
            return true;
        } catch(e) {
            console.warn('Audio play failed:', e);
            return false;
        }
    }

    function showCall(name) {
        displayName.textContent = name || 'Unknown';
        callScreen.style.display = 'flex';
        callScreen.setAttribute('aria-hidden', 'false');
        callStatus.textContent = 'Incoming WhatsApp call...';
        
        // Vibrate if supported (mobile)
        if ('vibrate' in navigator) {
            navigator.vibrate([200, 100, 200]);
        }
        
        // Play ringtone
        safePlay(ringtone).then(ok => {
            if(!ok) callStatus.textContent = 'Tap answer to start audio';
        });
    }

    function hideCall() {
        callScreen.style.display = 'none';
        callScreen.setAttribute('aria-hidden', 'true');
        ringtone.pause();
        ringtone.currentTime = 0;
        conversation.pause();
        conversation.currentTime = 0;
        callStatus.textContent = 'WhatsApp voice call...';
        clearCountdown();
        
        // Reset action buttons visibility
        document.querySelector('.call-actions').style.display = 'flex';
    }

    function clearCountdown() {
        if(countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }
        countdownArea.textContent = '';
    }

    // Button handlers
    nowBtn.addEventListener('click', () => {
        if(scheduleTimer) {
            clearTimeout(scheduleTimer);
            scheduleTimer = null;
        }
        clearCountdown();
        showCall(callerNameInput.value.trim() || 'Mom');
    });

    scheduleBtn.addEventListener('click', () => {
        const seconds = Math.max(0, parseInt(delayInput.value) || 0);
        
        if(scheduleTimer) clearTimeout(scheduleTimer);
        clearCountdown();
        
        if(seconds === 0) {
            showCall(callerNameInput.value.trim() || 'Mom');
            return;
        }

        // Show countdown in the main card
        let remaining = seconds;
        countdownArea.textContent = `Call scheduled in ${remaining}s`;
        
        countdownTimer = setInterval(() => {
            remaining -= 1;
            countdownArea.textContent = `Call scheduled in ${remaining}s`;
            
            if(remaining <= 0) {
                clearInterval(countdownTimer);
                countdownTimer = null;
                countdownArea.textContent = '';
            }
        }, 1000);

        scheduleTimer = setTimeout(() => {
            scheduleTimer = null;
            showCall(callerNameInput.value.trim() || 'Mom');
        }, seconds * 1000);
    });

    declineBtn.addEventListener('click', () => {
        hideCall();
    });

    answerBtn.addEventListener('click', async () => {
        // Stop ringtone and play conversation
        ringtone.pause();
        ringtone.currentTime = 0;
        callStatus.textContent = 'Connected...';
        
        // Replace action buttons with End Call button
        const callActions = document.querySelector('.call-actions');
        callActions.innerHTML = '';
        
        const endCallBtn = document.createElement('button');
        endCallBtn.className = 'action-btn action-decline';
        endCallBtn.innerHTML = 'üìû';
        endCallBtn.title = 'End Call';
        endCallBtn.style.width = '80px';
        endCallBtn.style.height = '80px';
        endCallBtn.style.fontSize = '32px';
        endCallBtn.onclick = () => {
            hideCall();
            // Restore original buttons
            callActions.innerHTML = `
                <button class="action-btn action-decline" id="declineBtn" title="Decline" aria-label="Decline call">
                    ‚úï
                </button>
                <button class="action-btn action-accept" id="answerBtn" title="Answer" aria-label="Answer call">
                    ‚úì
                </button>
            `;
            // Re-attach event listeners
            document.getElementById('declineBtn').addEventListener('click', () => hideCall());
            document.getElementById('answerBtn').addEventListener('click', answerCall);
        };
        callActions.appendChild(endCallBtn);
        
        const ok = await safePlay(conversation);
        
        if(!ok) {
            // If conversation couldn't autoplay, show manual start
            callStatus.textContent = 'Tap to start conversation';
            const startBtn = document.createElement('button');
            startBtn.textContent = '‚ñ∂ Start Conversation';
            startBtn.className = 'btn-fake-call';
            startBtn.style.marginTop = '16px';
            startBtn.onclick = async () => {
                await safePlay(conversation);
                startBtn.remove();
            };
            document.querySelector('.call-panel').appendChild(startBtn);
        }
    });
    
    // Named function for re-attachment
    async function answerCall() {
        ringtone.pause();
        ringtone.currentTime = 0;
        callStatus.textContent = 'Connected...';
        
        const callActions = document.querySelector('.call-actions');
        callActions.innerHTML = '';
        
        const endCallBtn = document.createElement('button');
        endCallBtn.className = 'action-btn action-decline';
        endCallBtn.innerHTML = 'üìû';
        endCallBtn.title = 'End Call';
        endCallBtn.style.width = '80px';
        endCallBtn.style.height = '80px';
        endCallBtn.style.fontSize = '32px';
        endCallBtn.onclick = () => {
            hideCall();
            callActions.innerHTML = `
                <button class="action-btn action-decline" id="declineBtn" title="Decline" aria-label="Decline call">
                    ‚úï
                </button>
                <button class="action-btn action-accept" id="answerBtn" title="Answer" aria-label="Answer call">
                    ‚úì
                </button>
            `;
            document.getElementById('declineBtn').addEventListener('click', () => hideCall());
            document.getElementById('answerBtn').addEventListener('click', answerCall);
        };
        callActions.appendChild(endCallBtn);
        
        const ok = await safePlay(conversation);
        if(!ok) {
            callStatus.textContent = 'Tap to start conversation';
            const startBtn = document.createElement('button');
            startBtn.textContent = '‚ñ∂ Start Conversation';
            startBtn.className = 'btn-fake-call';
            startBtn.style.marginTop = '16px';
            startBtn.onclick = async () => {
                await safePlay(conversation);
                startBtn.remove();
            };
            document.querySelector('.call-panel').appendChild(startBtn);
        }
    }

    // When conversation ends, close the call UI
    conversation.addEventListener('ended', () => {
        setTimeout(() => hideCall(), 1000);
    });

    // Prevent accidental scrolling on overlay
    callScreen.addEventListener('touchmove', e => {
        e.preventDefault();
    }, {passive: false});
</script>
{% endblock %}
