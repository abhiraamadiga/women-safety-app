{% extends "base.html" %}

{% block title %}Emergency Contacts{% endblock %}

{% block content %}
<style>
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --accent: #ff6b6b;
    --success: #51cf66;
}

.contacts-hero {
    background: var(--primary-gradient);
    color: white;
    padding: 3rem 0;
    margin-bottom: 3rem;
    border-radius: 1rem;
}

.contact-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border-left: 4px solid var(--accent);
}

.contact-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.priority-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-right: 0.5rem;
}

.priority-1 { background: #ff6b6b; color: white; }
.priority-2 { background: #ffa94d; color: white; }
.priority-3 { background: #74c0fc; color: white; }
.priority-4 { background: #a9e34b; color: white; }

.btn-add-contact {
    background: var(--success);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 2rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-add-contact:hover {
    background: #37b24d;
    color: white;
    transform: scale(1.05);
}

.btn-delete {
    background: var(--accent);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
}

.btn-edit {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    margin-right: 0.5rem;
}

.contact-info {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.contact-icon {
    width: 24px;
    height: 24px;
    margin-right: 0.75rem;
    opacity: 0.7;
}

.warning-box {
    background: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.modal-content {
    border-radius: 1rem;
}

.modal-header {
    background: var(--primary-gradient);
    color: white;
    border-radius: 1rem 1rem 0 0;
}
</style>

<div class="container py-4">
    <!-- Hero Section -->
    <div class="contacts-hero text-center">
        <h1 class="display-4 fw-bold">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom;">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Emergency Contacts
        </h1>
        <p class="lead mb-0">Manage your trusted contacts for emergency alerts</p>
    </div>

    <!-- Warning Box -->
    {% if contacts|length < 3 %}
    <div class="warning-box">
        <h5 class="mb-2">
            ⚠️ Add at least 3 emergency contacts
        </h5>
        <p class="mb-0">
            You need at least 3 emergency contacts to use the SOS feature. These contacts will be notified immediately when you trigger an emergency alert.
        </p>
    </div>
    {% endif %}

    <!-- Add Contact Button -->
    <div class="text-center mb-4">
        <button class="btn btn-add-contact" data-bs-toggle="modal" data-bs-target="#addContactModal">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom; margin-right: 0.5rem;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Emergency Contact
        </button>
    </div>

    <!-- Contacts List -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            {% if contacts %}
                {% for contact in contacts %}
                <div class="contact-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <span class="priority-badge priority-{{ contact.priority }}">
                                    Priority {{ contact.priority }}
                                </span>
                                <span class="badge bg-secondary">{{ contact.relationship }}</span>
                            </div>
                            <h5 class="mb-3">{{ contact.name }}</h5>
                            <div class="contact-info">
                                <svg class="contact-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                </svg>
                                <strong>{{ contact.phone }}</strong>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-edit btn-sm" onclick="editContact({{ contact.id }}, '{{ contact.name }}', '{{ contact.phone }}', '{{ contact.relationship }}', {{ contact.priority }})">
                                Edit
                            </button>
                            <button class="btn btn-delete btn-sm" onclick="deleteContact({{ contact.id }})">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5" style="margin-bottom: 1rem;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h5 class="text-muted">No contacts added yet</h5>
                    <p class="text-muted">Add your first emergency contact to get started</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add/Edit Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Emergency Contact</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="contactForm" onsubmit="saveContact(event)">
                    <input type="hidden" id="contactId" value="">
                    
                    <div class="mb-3">
                        <label for="contactName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="contactName" required maxlength="100">
                    </div>
                    
                    <div class="mb-3">
                        <label for="contactPhone" class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" id="contactPhone" required 
                               pattern="[0-9+\-\s()]+" title="Please enter a valid phone number" maxlength="20">
                        <small class="text-muted">Include country code if international (e.g., +91 9876543210)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contactRelationship" class="form-label">Relationship *</label>
                        <select class="form-select" id="contactRelationship" required>
                            <option value="">Select relationship...</option>
                            <option value="Mother">Mother</option>
                            <option value="Father">Father</option>
                            <option value="Sibling">Sibling</option>
                            <option value="Spouse">Spouse</option>
                            <option value="Friend">Friend</option>
                            <option value="Colleague">Colleague</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contactPriority" class="form-label">Priority (1-4) *</label>
                        <select class="form-select" id="contactPriority" required>
                            <option value="1">Priority 1 (Highest)</option>
                            <option value="2">Priority 2</option>
                            <option value="3">Priority 3</option>
                            <option value="4">Priority 4</option>
                        </select>
                        <small class="text-muted">Priority determines notification order during emergencies</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Save Contact</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function editContact(id, name, phone, relationship, priority) {
    document.getElementById('modalTitle').textContent = 'Edit Emergency Contact';
    document.getElementById('contactId').value = id;
    document.getElementById('contactName').value = name;
    document.getElementById('contactPhone').value = phone;
    document.getElementById('contactRelationship').value = relationship;
    document.getElementById('contactPriority').value = priority;
    
    const modal = new bootstrap.Modal(document.getElementById('addContactModal'));
    modal.show();
}

function saveContact(event) {
    event.preventDefault();
    
    const id = document.getElementById('contactId').value;
    const data = {
        name: document.getElementById('contactName').value,
        phone: document.getElementById('contactPhone').value,
        relationship: document.getElementById('contactRelationship').value,
        priority: parseInt(document.getElementById('contactPriority').value)
    };
    
    const url = id ? `/api/emergency-contacts/${id}` : '/api/emergency-contacts';
    const method = id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Could not save contact'));
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Failed to save contact. Please try again.');
    });
}

function deleteContact(id) {
    if (!confirm('Are you sure you want to delete this emergency contact?')) {
        return;
    }
    
    fetch(`/api/emergency-contacts/${id}`, {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Could not delete contact'));
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Failed to delete contact. Please try again.');
    });
}

// Reset form when modal is closed
document.getElementById('addContactModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('contactForm').reset();
    document.getElementById('contactId').value = '';
    document.getElementById('modalTitle').textContent = 'Add Emergency Contact';
});
</script>
{% endblock %}
